<!DOCTYPE html>
<html>
<head>
    <title>Health AI Chat</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        :root{
            --bg:#0b1220;
            --accent:#39f0e0;
            --accent2:#4fc3f7;
            --text:#e6f3fb;
            --muted:#94a3b8;
        }

        *{
            box-sizing:border-box;
            font-family:'Inter',sans-serif;
        }

        body{
            margin:0;
            background:linear-gradient(180deg,#07101a,#0b1624);
            color:var(--text);
            display:flex;
            flex-direction:column;
            height:100vh;
        }

        /* ================= HEADER ================= */
        .header{
            padding:30px 60px;
            background:rgba(255,255,255,0.04);
            border-bottom:1px solid rgba(255,255,255,0.06);
            display:flex;
            justify-content:space-between;
            align-items:center;
        }

        .header h1{
            margin:0;
            font-size:36px;
            font-weight:700;
            background:linear-gradient(90deg,var(--accent2),var(--accent));
            -webkit-background-clip:text;
            -webkit-text-fill-color:transparent;
        }

        .languageBox{
            display:flex;
            align-items:center;
            gap:18px;
        }

        .langLabel{
            font-size:20px;
            font-weight:600;
            color:var(--accent);
        }

        #language{
            padding:16px 22px;
            font-size:18px;
            font-weight:600;
            border-radius:14px;
            border:none;
            background:linear-gradient(90deg,var(--accent2),var(--accent));
            color:#00181a;
            cursor:pointer;
            min-width:200px;
        }

        /* ================= CHAT AREA ================= */
        #chatBox{
            flex:1;
            overflow-y:auto;
            padding:60px 140px;
            display:flex;
            flex-direction:column;
            gap:28px;
            font-size:18px;
        }

        .user,.ai{
            max-width:60%;
            padding:20px 24px;
            border-radius:20px;
            line-height:1.6;
            animation:fadeIn .2s ease;
        }

        .user{
            align-self:flex-end;
            background:linear-gradient(90deg,#7ef7c7,#39f0e0);
            color:#00181a;
            border-bottom-right-radius:6px;
        }

        .ai{
            align-self:flex-start;
            background:#1e293b;
            border:1px solid rgba(255,255,255,0.06);
            border-bottom-left-radius:6px;
        }

        @keyframes fadeIn{
            from{opacity:0;transform:translateY(8px);}
            to{opacity:1;transform:translateY(0);}
        }

        #loading{
            display:none;
            color:var(--muted);
            padding:0 140px;
            font-size:16px;
        }

        #status{
            color:var(--muted);
            padding:0 140px 15px 140px;
            font-size:15px;
        }

        /* ================= INPUT AREA ================= */
        .inputArea{
            padding:25px 140px;
            background:rgba(255,255,255,0.04);
            border-top:1px solid rgba(255,255,255,0.06);
            display:flex;
            gap:15px;
        }

        input{
            flex:1;
            padding:18px;
            border-radius:18px;
            border:none;
            outline:none;
            background:#1e293b;
            color:var(--text);
            font-size:18px;
        }

        button{
            padding:16px 22px;
            border:none;
            border-radius:14px;
            cursor:pointer;
            font-weight:600;
            font-size:16px;
            transition:0.2s;
        }

        .sendBtn{
            background:linear-gradient(90deg,var(--accent2),var(--accent));
            color:#00181a;
        }

        .voiceBtn{
            background:#1e293b;
            color:var(--accent);
        }

        .voiceBtn.listening{
            background:linear-gradient(90deg,var(--accent2),var(--accent));
            color:#00181a;
        }

        .stopBtn{
            background:#1e293b;
            color:#f87171;
        }

        button:hover{
            transform:translateY(-3px);
        }

        /* Responsive */
        @media(max-width:1000px){
            #chatBox{padding:30px;}
            .inputArea{padding:20px;}
            #loading,#status{padding:0 30px;}
            .header{flex-direction:column;gap:20px;}
        }
    </style>
</head>

<body>

<!-- HEADER -->
<div class="header">
    <h1>Health AI Assistant ðŸ©º</h1>

    <div class="languageBox">
        <span class="langLabel">Select Your Language:</span>

        <select id="language">
            <option value="English">English</option>
            <option value="Hindi">Hindi</option>
            <option value="Marathi">Marathi</option>
        </select>
    </div>
</div>

<!-- CHAT -->
<div id="chatBox"></div>
<div id="loading">AI is typing...</div>
<div id="status"></div>

<!-- INPUT -->
<div class="inputArea">
    <input type="text" id="manualInput"
           placeholder="Ask your health question..."
           onkeypress="handleEnter(event)">

    <button class="sendBtn" onclick="sendManual()">Send</button>
    <button id="voiceBtn" class="voiceBtn"
            onclick="toggleContinuousListen()">ðŸŽ¤</button>
    <button class="stopBtn" onclick="stopAll()">â›”</button>
</div>

<script>
/* =======================
   YOUR ORIGINAL LOGIC
   (UNCHANGED)
======================= */

let recognition = null;
let isContinuousMode = false;
let currentAudio = null;

function appendMessage(text, sender) {
    const box = document.getElementById("chatBox");
    const div = document.createElement("div");
    div.className = sender;
    div.innerText = text;
    box.appendChild(div);
    box.scrollTop = box.scrollHeight;
}

function handleEnter(e) {
    if (e.key === "Enter") sendManual();
}

function sendManual() {
    const input = document.getElementById("manualInput");
    const text = input.value.trim();
    if (!text) return;

    appendMessage("You: " + text, "user");
    input.value = "";
    stopAudio();
    sendToBackend(text);
}

function getSpeechLang() {
    const selected = document.getElementById("language").value;
    if (selected === "Hindi") return "hi-IN";
    if (selected === "Marathi") return "mr-IN";
    return "en-US";
}

function toggleContinuousListen() {
    const btn = document.getElementById("voiceBtn");

    if (isContinuousMode) {
        isContinuousMode = false;
        stopRecognition();
        btn.classList.remove("listening");
        return;
    }

    isContinuousMode = true;
    btn.classList.add("listening");
    startRecognition();
}

async function startRecognition() {
    const SpeechRecognition =
        window.SpeechRecognition || window.webkitSpeechRecognition;

    if (!SpeechRecognition) {
        alert("Use Chrome or Edge for voice input.");
        return;
    }

    try {
        await navigator.mediaDevices.getUserMedia({ audio: true });
    } catch {
        alert("Allow microphone access.");
        return;
    }

    if (!recognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = false;

        recognition.onresult = (event) => {
            const transcript =
                event.results[event.results.length - 1][0].transcript;
            appendMessage("You: " + transcript, "user");
            stopAudio();
            sendToBackend(transcript);
        };

        recognition.onend = () => {
            if (isContinuousMode) recognition.start();
        };
    }

    recognition.lang = getSpeechLang();
    recognition.start();
}

function stopRecognition() {
    if (recognition) recognition.stop();
}

function sendToBackend(message) {
    const language = document.getElementById("language").value;

    document.getElementById("loading").style.display = "block";

    fetch('/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message, language })
    })
    .then(res => res.json())
    .then(data => {
        document.getElementById("loading").style.display = "none";
        appendMessage("AI: " + data.reply, "ai");
        if (data.tts_url) playAudio(data.tts_url);
    });
}

function playAudio(url) {
    stopAudio();
    currentAudio = new Audio(url);
    currentAudio.playbackRate = 1.4;
    currentAudio.play();
}

function stopAudio() {
    if (currentAudio) {
        currentAudio.pause();
        currentAudio.currentTime = 0;
        currentAudio = null;
    }
}

function stopAll() {
    isContinuousMode = false;
    stopRecognition();
    stopAudio();
}
</script>

</body>
</html>